<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<!-- Bootstrap CSS -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
	crossorigin="anonymous">

</head>
<body class="container mt-5">

	<a href="index.html" class="btn btn-outline-secondary mb-3">← Voltar</a><!-- a tag <a> cria um link navegável -->

	<h1 class="mb-4">CADASTRO DE USUÁRIOS:</h1>

	<!-- Bootstrap JS -->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
		crossorigin="anonymous"></script>


	<!-- TODAS AS CLASSES BOOTSTRAP DESTE INDEX SÃO CLASSES RESPONSIVAS -->

	<!-- div é um conteiner
    - label descreve o campo input
    - input é um campo de entrada
    - o for vincula o label ao campo de entreda com mesmo nome (id) -->

	<!-- Formulário de Cadastro -->
	<form id="formUsuario" class="mb-2 mb-md-4 mb-lg-5">
		<div class="row g-3 mb-2 mb-md-3 mb-lg-4">
			<div class="col-12 col-sm-6 col-md-2 col-lg-2">
				<input type="text" class="form-control" id="id" readonly="readonly"
					placeholder="ID automático">
			</div>
			<div class="col-12 col-sm-6 col-md-2 col-lg-3">
				<input type="text" id="nome" class="form-control" placeholder="Nome"
					required>
			</div>
			<div class="col-12 col-sm-6 col-md-2 col-lg-2">
				<select id="sexo" class="form-select" required>
					<option value="">Selecione o sexo</option>
					<option value="Masculino">Masculino</option>
					<option value="Feminino">Feminino</option>
				</select>
			</div>
			<div class="col-12 col-sm-6 col-md-2 col-lg-2">
				<input type="number" id="idade" class="form-control"
					placeholder="Idade" required>
			</div>
			<div class="col-12 col-sm-6 col-md-2 col-lg-2">
				<input type="text" id="cpf" class="form-control"
					placeholder="CPF" maxlength="14" required>
			</div>
			<div class="row mt-2 mt-md-3">
				<div class="col-12 d-grid gap-2 d-md-flex justify-content-md-start">
					<button type="button" class="btn btn-primary"
						onclick="salvarUsuario()">Salvar</button>
					<button type="button" class="btn btn-secondary"
						onclick="document.getElementById('formUsuario').reset();">Novo</button>
					<!-- esse reset limpa os campos do formulário -->
					<button type="button" class="btn btn-success"
						data-bs-toggle="modal" data-bs-target="#modalPesquisar">Pesquisar</button>
					<!-- chama a tela modal -->
					<button type="button" class="btn btn-danger"
						onclick="botaoDeletarTelaInicial()">Deletar</button>
				</div>

				<!-- TELA MODAL -->
				<div class="modal fade" id="modalPesquisar" tabindex="-1"
					aria-labelledby="exampleModalLabel" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered modal-lg">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="exampleModalLabel">Buscar por
									Usuário</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"
									aria-label="Close"></button>
							</div>
							<div class="modal-body">
								<form>
									<div class="mb-2 mb-md-3">
										<label for="nomeBuscar" class="col-form-label">Nome:</label> <input
											type="text" class="form-control" id="nomeBuscar">
									</div>
									<div class="d-grid d-md-flex justify-content-md-start mb-2 mb-md-3">
										<button type="button" class="btn btn-success"
											onclick="buscarUsuario()">Buscar</button>
									</div>
								</form>

								<div id="divTabelaDados"></div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary"
									data-bs-dismiss="modal">Fechar</button>
							</div>
						</div>
					</div>
				</div>

			</div>
		</div>
	</form>

	<!-- Tabela de Usuários -->
	<div id="divTabelaDados" class="table-responsive mt-3 mt-md-4"
		style="max-height: 60vh; overflow-y: auto;">
		<table class="table table-striped" id="tabelaDados">
			<thead class="table-light">
				<tr>
					<th>ID</th>
					<th>Nome</th>
					<th>Sexo</th>
					<th>Idade</th>
					<th>CPF</th>
					<th>Ações</th>
				</tr>
			</thead>
			<tbody>
				<!-- Linhas serão adicionadas dinamicamente -->
			</tbody>
		</table>
	</div>


	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"
		integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
		crossorigin="anonymous"></script>
	<!-- jQuery me permite escrever comandos em javascript com menos código -->

	<script type="text/javascript">
	
	function salvarUsuario() { //acionado pelo botão SALVAR

		var id = $("#id").val(); //"#id" é o id do meu input ID - val() resgata o valor contido dentro deste input
		var nome = $("#nome").val(); //"#nome" é o id do meu input NOME - val() resgata o valor contido dentro deste input
		var sexo = $("#sexo").val(); //"#sexo" é o id do meu input SEXO - val() resgata o valor contido dentro deste input
		var idade = $("#idade").val(); //"#idade" é o id do meu input IDADE - val() resgata o valor contido dentro deste input
		var cpf = $("#cpf").val(); //"#cpf" é o id do meu input CPF - val() resgata o valor contido dentro deste input
		
		
		if (nome == null || nome.trim() == '') {//validação para verificar se o nome está nulo ou se está vazio
			$("#nome").focus();//foca no campo
			alert("Informe o nome do usuário!");
			return;
		}

		if (sexo == null || sexo.trim() == '') {//validação para verificar se o sexo está nula ou se está vazio
			$("#sexo").focus();//foca no campo
			alert("Informe o sexo do usuário!");
			return;
		}
		
		if (idade == null || idade.trim() == '') {//validação para verificar se a idade está nula ou se está vazia
			$("#idade").focus();//foca no campo
			alert("Informe a idade do usuário!");
			return;
		}
		
		if (cpf == null || cpf.trim() == '') {//validação para verificar se o cpf está nulo ou se está vazio
			$("#cpf").focus();//foca no campo
			alert("Informe o CPF do usuário!");
			return;
		}
		

		/*AJAX é uma técnica que permite que uma página web se comunique com o servidor, em segundo plano, e por isso 
		a página não recarrega, e as informações chegam na mesma*/
		//ajax é uma receita de bolo:
		$.ajax({ //chamada AJAX com jQuery
			method : "POST", //por se tratar do endpoint salvar, que é um do tipo POST
			url : "usuario/salvar", //mapeamento do meu endpoint
			data : JSON.stringify({//converte os dados de JS para JSON, para serem enviados no corpo requisição feita ao endpoint 
				id : id,//1 -parâmtros do objeto : 2 - valor do formulário
				nome : nome,
				sexo : sexo,
				idade : idade,
				cpf : cpf
			}),
			contentType : "application/json; charset=utf-8",//tipo dos dados
			success : function(response) {//esse response, é o retorno do meu endpoint "salvar"
				$("#id").val(response.id);//"#id" é o id do meu input ID - val(com este campo preenchido) escreve o valor do parâmetro na tela
				alert("Dados cadastrados com sucesso!"); 
			}
		}).fail(
				function(xhr, status, errorThrow) {//xhr: traz detalhes da resposta; status: status http; errorthrow: mensagem de erro
					alert("Erro! Não conseguimos salvar os dados: "
							+ xhr.responseText);
				});

		/*O objetivo final é que, ao clicar no botão "salvar", este chame uma função JS, que possui um ajax, que irá capturar os dados 
		do formulário, depois irá convertê-los para json, para então os enviar, no corpo da requisição, para o endpoint "salvar"; 
		este por sua vez, recebe o json, converte-o para um objeto, em seguida conecta-se ao banco de dados e salva aquele objeto;
		por último, meu endpoint retorna a este - que antes será traduzido para json pelo @ResponseBody, para o ajax, no parâmetro 
		"response" do método "function()"; e será este mesmo ajax, o responsável por colocar os dados na tela. 
		*/ 

	}
	
	function buscarUsuario() {//acionado pelo botão BUSCAR da tela modal
		
		var nome = $("#nomeBuscar").val();//"#nomeBuscar" é o id do meu input NOME da tela modal - val() resgata o valor contido dentro deste input
		
		if (nome != null && nome.trim() != '') {//validação para verificar se o nome está nulo ou se está vazio
			
		$.ajax(	
			{ //chamada AJAX com jQuery
				method : "GET", //por se tratar do endpoint buscarPeloNome, que é um do tipo GET
				url : "usuario/buscarPeloNome", //mapeamento do meu endpoint
				data : "nome=" + nome,// "nome" é o nome do parâmetro do endponint "buscarPeloNome" - nome é o valor da variável js 
				//como é um GET, os parâmtros não precisam ser convertidos para json, mas passão como query string na url;
				success : function(response) {//se der certo, será enviada a resposta
					$("#tabelaDados > tbody > tr").remove();//entra na tebela, depois na linha, e limpa os dados lá estiverem sendo exibidos 
					$("#modalPesquisar").modal("hide");//esconde o modal quando eu clico no botão BUSCAR
					
					for (var i = 0; i < response.length; i++) {//como o endpoint "buscarPeloNome" retorna uma lista, devo percorre-la
					    $("#tabelaDados > tbody").append(//entro no corpo da tabela e escrevo linhas e colunas
					        "<tr id='idLinha'>" + //na linha...
					        	"<td>" + response[i].id + "</td>" + //na 1° coluna: coloco o id do usuário
					            "<td>" + response[i].nome + "</td>" + //na 2° coluna: coloco o nome do usuário
					            "<td>" + response[i].sexo + "</td>" + //na 3° coluna: coloco o sexo do usuário
					            "<td>" + response[i].idade + "</td>" + //na 4° coluna: coloco o idade do usuário
					            "<td>" + response[i].cpf + "</td>" + //na 5° coluna: coloco a cpf do usuário
					            "<td>" +
					                "<button type='button' class='btn btn-primary btn-sm me-2' onclick='colocarEmEdicao(" + response[i].id + ")'>Ver</button>" + //na 6° coluna: coloco o botão VER
					                "<button type='button' class='btn btn-danger btn-sm' onclick='deletarUsuario(" + response[i].id + ")'>Deletar</button>" + //também na 6° coluna: coloco o botão DELETAR
					            "</td>" +
					        "</tr>"
					    );
					}

				}
			}).fail(
			function(xhr, status, errorThrow) {//xhr: traz detalhes da resposta; status: status http; errorthrow: mensagem de erro
				alert("Erro ao buscar produto pelo nome!: "
						+ xhr.responseText);
			});
		}

	}
	
	function colocarEmEdicao(id) {//chamado pelo botão VER

		$.ajax({ //chamada AJAX com jQuery
			method : "GET", //por se tratar do método buscarPeloId, que é um do tipo GET
			url : "usuario/buscarPorId", //mapeamento do meu endpoint
			data : "id=" + id, //"id" é o nome do parâmetro do endponint "buscarPeloId" - id é o valor do parâmtro da função js
			//como é um GET, os parâmtros não precisam ser convertidos para json, mas passão como query string na url;
			success : function(response) {//esse response, é o retorno do meu endpoint "salvar"
				$("#id").val(response.id); //"#id" é o id do meu input ID - val(com este campo preenchido) escreve o valor do parâmetro na tela  
				$("#nome").val(response.nome); //val() - se estiver vazio, pega os valores dos campos da tela; porém se estiver carregando um parâmtro com ele, acaba por inserir seu valor nos campos da tela
				$("#sexo").val(response.sexo);
				$("#idade").val(response.idade);
				$("#cpf").val(response.cpf); 

			}

		}).fail(function(xhr, status, errorThrow) {//xhr: traz detalhes da resposta; status: status http; errorthrow: mensagem de erro
			alert("Erro ao buscar usuário pelo id!" + xhr.responseText);
		});
	}
	
	function deletarUsuario(id) {//chamado pelo botão DELETAR da tela modal

		if (confirm("Deseja mesmo deletar?")) {//exibe uma confirmação na tela 

			$.ajax({ //chamada AJAX com jQuery
				method : "DELETE", //por se tratar do método "deletar"", que é um do tipo DELETE
				url : "usuario/deletar", //mapeamento do meu endpoint
				data : "id=" + id, //"id" é o nome do parâmetro do endponint "DELETAR" - id é o valor do parâmtro da função js
				//como é um GET, os parâmtros não precisam ser convertidos para json, mas passão como query string na url;
				success : function(response) {//esse response, é o retorno do meu endpoint "salvar"
					alert(response);//exibe o response/retorno na tela - neste caso, meu retorno é uma String

					$('#idLinha').remove();//remove a linha que contém os dados do usuário recém deletado impressos na tela
					
				}

			}).fail(
					function(xhr, status, errorThrow) {//xhr: traz detalhes da resposta; status: status http; errorthrow: mensagem de erro
						alert("Erro ao deletar usuário pelo ID!"
								+ xhr.responseText);
					});

		}

	}
	
	function botaoDeletarTelaInicial() {//chamado pelo botão DELETAR da tela inicial
		var id = $("#id").val();//"#id" é o id do meu input ID - val() resgata o valor contido dentro deste input

		if (id != null && id.trim() != '') {//verifica se o id é diferente de nulo e se não está vazio
			deletarUsuario(id);//chamo a função "deletarUsuario(id)" para deletar o usuário para min 
			document.getElementById('formUsuario').reset();//limpa os inputs do formulário
		} else {
			alert("Não há nenhum usuário a ser deletado!");
		}

	}
	
	</script>
	
	<script>
	$(document).ready(function() {//esta linha espera até que todo o conteúdo da página esteja carregado para executar o código dentro da função.
    	$("#cpf").on("input", function() {//Quando o usuário digitar qualquer coisa (evento input) dentro do campo com id="cpf", execute a função.
        // Remove tudo que não for número
        var cpf = $(this).val().replace(/\D/g, ''); //$(this).val() pega o valor atual do campo.
        											//replace(/\D/g, '') remove tudo que não for número (\D = "não dígito", e o g é para aplicar globalmente).

        // Limita a 11 dígitos
        cpf = cpf.substring(0, 11);//Mantém apenas os 11 primeiros dígitos (padrão do CPF), ignorando o resto se houver.

        // Adiciona a formatação
        	if (cpf.length > 9) {
            	cpf = cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, "$1.$2.$3-$4");
         		/**
         		Se o CPF tiver mais de 9 dígitos, aplica a formatação completa:
				12345678900 vira 123.456.789-00
				(\d{3}) pega 3 dígitos (e os guarda em $1)
				Os outros grupos capturam o restante do CPF
				O formato final é $1.$2.$3-$4 -> 123.456.789-00
				
         		*/
        	} else if (cpf.length > 6) {
            	cpf = cpf.replace(/(\d{3})(\d{3})(\d{1,3})/, "$1.$2.$3");
            	
            	/*
            	Se o CPF tiver entre 7 e 9 dígitos, aplica só a formatação com dois pontos:
				Exemplo: 123456789 -> 123.456.789
            	*/
            	
        	} else if (cpf.length > 3) {
            	cpf = cpf.replace(/(\d{3})(\d{1,3})/, "$1.$2");
            	
            	/*
            	Se o CPF tiver entre 4 e 6 dígitos, aplica só um ponto:
				Exemplo: 123456 -> 123.456
            	*/
            	
        	}
        	$(this).val(cpf);//Atualiza o valor do campo com o CPF formatado, substituindo o valor anterior (sem formatação).
    	});
	});
	</script>
	

</body>
</html>