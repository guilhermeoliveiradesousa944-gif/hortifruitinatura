<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Fornecedores</title>

<!-- Bootstrap CSS -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
  crossorigin="anonymous">
</head>
<body class="container mt-5">

  <a href="index.html" class="btn btn-outline-secondary mb-3">← Voltar</a>
  <h1 class="mb-4">CADASTRO DE FORNECEDORES</h1>

  <!-- Formulário -->
  <form id="formFornecedor" class="mb-5">
    <div class="row g-3">

      <div class="col-md-1">
        <input type="text" id="id" class="form-control" placeholder="ID" readonly>
      </div>

      <div class="col-md-3">
        <input type="text" id="nome" class="form-control" placeholder="Nome" required>
      </div>

      <div class="col-md-2">
        <input type="text" id="telefone" class="form-control" placeholder="(DDD) 99999-9999" required>
      </div>

      <div class="col-md-3">
        <input type="text" id="cnpj" class="form-control" placeholder="CNPJ 00.000.000/0000-00" required>
      </div>

      <div class="col-md-3">
        <select id="estado" class="form-select" required>
          <option value="">Selecione o estado</option>
          <option>AC</option><option>AL</option><option>AP</option><option>AM</option>
          <option>BA</option><option>CE</option><option>DF</option><option>ES</option>
          <option>GO</option><option>MA</option><option>MT</option><option>MS</option>
          <option>MG</option><option>PA</option><option>PB</option><option>PR</option>
          <option>PE</option><option>PI</option><option>RJ</option><option>RN</option>
          <option>RS</option><option>RO</option><option>RR</option><option>SC</option>
          <option>SP</option><option>SE</option><option>TO</option>
        </select>
      </div>

      <div class="col-md-3">
        <input type="text" id="cidade" class="form-control" placeholder="Cidade" required>
      </div>

      <div class="col-md-3">
        <input type="text" id="bairro" class="form-control" placeholder="Bairro" required>
      </div>

      <div class="col-md-3">
        <input type="text" id="logradouro" class="form-control" placeholder="Logradouro" required>
      </div>

      <div class="col-md-2">
        <input type="text" id="numero" class="form-control" placeholder="Número" required>
      </div>

      <div class="col-md-2">
        <input type="text" id="cep" class="form-control" placeholder="CEP 00000-000" required>
      </div>
    </div>

    <!-- Botões -->
    <div class="mt-4 d-flex flex-wrap gap-2">
      <button type="button" class="btn btn-primary" onclick="salvarFornecedor()">Salvar</button>
      <button type="button" class="btn btn-secondary" onclick="document.getElementById('formFornecedor').reset();">Novo</button>
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalPesquisar">Pesquisar</button>
      <button type="button" class="btn btn-danger" onclick="botaoDeletarTelaInicial()">Deletar</button>
    </div>
  </form>

  <!-- Modal -->
  <div class="modal fade" id="modalPesquisar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Buscar Fornecedor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="nomeBuscar" class="form-control mb-3" placeholder="Digite o nome">
          <button type="button" class="btn btn-success mb-3" onclick="buscarFornecedor()">Buscar</button>
          <div id="divTabelaDados"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabela -->
  <div id="divTabelaDados" class="table-responsive mt-3" style="max-height: 60vh; overflow-y: auto;">
    <table class="table table-striped" id="tabelaDados">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>Telefone</th>
          <th>CNPJ</th>
          <th>Estado</th>
          <th>Cidade</th>
          <th>Bairro</th>
          <th>Logradouro</th>
          <th>Número</th>
          <th>CEP</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- jQuery + Bootstrap -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

  <script>
    $(document).ready(function(){
      $('#telefone').mask('(00) 00000-0000');
      $('#cnpj').mask('00.000.000/0000-00');
      $('#cep').mask('00000-000');
    });

    function salvarFornecedor() {

      var id = $("#id").val();
      var nome = $("#nome").val();
      var telefone = $("#telefone").val();
      var cnpj = $("#cnpj").val();
      var estado = $("#estado").val();
      var cidade = $("#cidade").val();
      var bairro = $("#bairro").val();
      var logradouro = $("#logradouro").val();
      var numero = $("#numero").val();
      var cep = $("#cep").val();

      // Validações completas:
      if (nome == null || nome.trim() == '') {
        $("#nome").focus();
        alert("Informe o nome do fornecedor!");
        return;
      }

      if (telefone == null || telefone.trim() == '') {
        $("#telefone").focus();
        alert("Informe o telefone do fornecedor!");
        return;
      }

      if (cnpj == null || cnpj.trim() == '') {
        $("#cnpj").focus();
        alert("Informe o CNPJ do fornecedor!");
        return;
      }

      if (estado == null || estado.trim() == '') {
        $("#estado").focus();
        alert("Selecione o estado do fornecedor!");
        return;
      }

      if (cidade == null || cidade.trim() == '') {
        $("#cidade").focus();
        alert("Informe a cidade do fornecedor!");
        return;
      }

      if (bairro == null || bairro.trim() == '') {
        $("#bairro").focus();
        alert("Informe o bairro do fornecedor!");
        return;
      }

      if (logradouro == null || logradouro.trim() == '') {
        $("#logradouro").focus();
        alert("Informe o logradouro do fornecedor!");
        return;
      }

      if (numero == null || numero.trim() == '') {
        $("#numero").focus();
        alert("Informe o número do fornecedor!");
        return;
      }

      if (cep == null || cep.trim() == '') {
        $("#cep").focus();
        alert("Informe o CEP do fornecedor!");
        return;
      }

      // Envio via AJAX
      $.ajax({
        method: "POST",
        url: "fornecedor/salvar",
        data: JSON.stringify({
          id: id,
          nome: nome,
          telefone: telefone,
          cnpj: cnpj,
          estado: estado,
          cidade: cidade,
          bairro: bairro,
          logradouro: logradouro,
          numero: numero,
          cep: cep
        }),
        contentType: "application/json; charset=utf-8",
        success: function(response) {
          $("#id").val(response.id);
          alert("Fornecedor salvo com sucesso!");
        },
        error: function(xhr) {
          alert("Erro ao salvar: " + xhr.responseText);
        }
      });
    }

    function buscarFornecedor() {
      var nome = $("#nomeBuscar").val();
      if (nome == null || nome.trim() == '') {
        alert("Informe um nome para buscar!");
        return;
      }

      $.ajax({
        method: "GET",
        url: "fornecedor/buscarPeloNome",
        data: "nome=" + nome,
        success: function(response) {
          $("#tabelaDados > tbody").empty();
          $("#modalPesquisar").modal("hide");

          for (var i = 0; i < response.length; i++) {
            $("#tabelaDados > tbody").append(
              "<tr>" +
              "<td>"+response[i].id+"</td>" +
              "<td>"+response[i].nome+"</td>" +
              "<td>"+response[i].telefone+"</td>" +
              "<td>"+response[i].cnpj+"</td>" +
              "<td>"+response[i].estado+"</td>" +
              "<td>"+response[i].cidade+"</td>" +
              "<td>"+response[i].bairro+"</td>" +
              "<td>"+response[i].logradouro+"</td>" +
              "<td>"+response[i].numero+"</td>" +
              "<td>"+response[i].cep+"</td>" +
              "<td>" +
                "<button class='btn btn-primary btn-sm me-2' onclick='colocarEmEdicao("+response[i].id+")'>Editar</button>" +
                "<button class='btn btn-danger btn-sm' onclick='deletarFornecedor("+response[i].id+")'>Deletar</button>" +
              "</td></tr>"
            );
          }
        },
        error: function(xhr) {
          alert("Erro ao buscar fornecedor: " + xhr.responseText);
        }
      });
    }

    function colocarEmEdicao(id) {
      $.ajax({
        method: "GET",
        url: "fornecedor/buscarPorId",
        data: "id=" + id,
        success: function(r) {
          $("#id").val(r.id);
          $("#nome").val(r.nome);
          $("#telefone").val(r.telefone);
          $("#cnpj").val(r.cnpj);
          $("#estado").val(r.estado);
          $("#cidade").val(r.cidade);
          $("#bairro").val(r.bairro);
          $("#logradouro").val(r.logradouro);
          $("#numero").val(r.numero);
          $("#cep").val(r.cep);
        },
        error: function(xhr) {
          alert("Erro ao buscar fornecedor: " + xhr.responseText);
        }
      });
    }

    function deletarFornecedor(id) {
      if (confirm("Deseja realmente deletar este fornecedor?")) {
        $.ajax({
          method: "DELETE",
          url: "fornecedor/deletar",
          data: "id=" + id,
          success: function(response) {
            alert(response);
            buscarFornecedor();
          },
          error: function(xhr) {
            alert("Erro ao deletar: " + xhr.responseText);
          }
        });
      }
    }

    function botaoDeletarTelaInicial() {
      var id = $("#id").val();
      if (id == null || id.trim() == '') {
        alert("Nenhum fornecedor selecionado para exclusão!"); 
        return;
      }
      deletarFornecedor(id);
      document.getElementById('formFornecedor').reset();
    }
  </script>

</body>
</html>
